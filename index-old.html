<!DOCTYPE html>
<body>
<script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
<!-- fallback in case jQuery failed to load from jQuery CDN -->
<script>window.jQuery || document.write('<script src="js/jquery-1.9.1.min.js">\x3C/script>')</script>
<script src="js/lib/handlebars.min.js"></script>
<script src="js/lib/marked/marked.min.js"></script>
<script>

function log(msg) {
	if (window.console) console.log(msg);
}

function byId(id) {
	return document.getElementById(id);
}

var domExtensions = {
	window: function() {
		return window;
	}
}

domExtensions.window.on = function(eventName, handler) {
	on(window, eventName, handler);
}

function on(element, eventName, handler) {
	$(element).on(eventName, handler);
}

var indexMainContent;

//get homepage main content
$.get('index.md', function(markdownSrc) {
	homepageMainContent = marked(markdownSrc);
})
.then(function() {
 $.get('template.handlebars', function(templateSource) {
	var template = Handlebars.compile(templateSource);	
	var html = template({
		siteTitle: 'After School System Wireframes',
		pageTitle: 'Home',
		pageContent: homepageMainContent 
	});
	
	//get the head section of the template
	var $head = $('<div>'+ html.match(/<head[^>]*>([\s\S]*)<\/head>/i)[1] +'</div>');
	//append to real <head>
	$('head').append($head.children());
	
	//once the last stylesheet has finished loading, add the body
	//(TODO: find out if the last stylesheet in the HTML is always the last one to finish loading
	//or if it's more asynchronous than that)
	$('head > link').last().load(function() {
		//get the body section of the template
		var $body = $('<div>'+ html.match(/<body[^>]*>([\s\S]*)<\/body>/i)[1] +'</div>');
		//append to real <body>
		$('body').append($body.children());
		
		onTemplateLoaded();
	});
 })
});

function onTemplateLoaded() {
	prefixInternalLinksWithHash();
	domExtensions.window.on('hashchange', onHashChange);
}

function onHashChange() {
	var hash = location.hash;
	if (hash[1]!='/') return;
	
	var pageUrl = hash.substr(2);
	
	//retrieve the Markdown file for the page, parse it, and display it
	$.get(pageUrl + '.md', function(markdownSrc) {
		byId('pageContent').innerHTML = marked(markdownSrc);
	});
}

function prefixInternalLinksWithHash(context) {
	var siteHostname = window.location.hostname;
	$("a", context).attr("href", function(i, href) {
		if (href[0]!='#' && this.hostname == siteHostname) {
			return '#/' + href;
		}
	});
}
	
</script>
</body>